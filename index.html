<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload Videos</title>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7f8}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:20px;margin:0 0 18px}
    h1{margin:0 0 6px;font-size:28px}
    .sub{margin:0 0 14px;color:#555}
    button{
      padding:10px 14px;
      border:1px solid #d0d0d0;
      border-radius:10px;
      background:#fff;
      color:#111 !important; /* force visible text */
      cursor:pointer;
      min-width:96px;
    }
    button.btn-danger{
      background:#fff5f5;
      border-color:#f3b4b4;
    }
    .muted{color:#555;font-size:12px}

    /* Upload queue */
    .queue{display:grid;gap:8px;margin-top:12px}
    .row{display:flex;gap:10px;align-items:center;padding:8px 10px;border:1px solid #eee;border-radius:10px;background:#fafafa}
    .name{flex:1;min-width:0;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef;border:1px solid #dde;color:#334}
    .ok{background:#e9f9ee;border-color:#cdeccd;color:#115d2a}
    .err{background:#fdecec;border-color:#f5c2c2;color:#8a1f1f}
    .bar{position:relative;flex:0 0 160px;height:6px;border-radius:999px;background:#e6e6e6;overflow:hidden}
    .bar > i{position:absolute;inset:0;display:block;background:linear-gradient(90deg,#bdbdbd,#d9d9d9,#bdbdbd);animation:slide 1.1s linear infinite}
    @keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* Gallery */
    .row-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card-v{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px}
    .card-v video,.card-v img{width:100%;border-radius:8px;display:block}
    .meta{font:12px/1.3;color:#555;margin-top:6px;word-break:break-all;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .meta .left{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btns{display:flex;gap:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Uploader -->
    <div class="card">
      <h1>Upload Videos</h1>
      <p class="sub">Drag & drop in the popup or click the button. <strong>Max 6&nbsp;MB</strong>. Accepted: MP4 / MOV / WEBM / GIF.</p>
      <div class="row-head">
        <button id="uploadBtn">Select videos</button>
        <span class="muted">Uploads go to folder <code>readymag_videos</code> with tag <code>portfolio-vids</code>.</span>
      </div>

      <!-- Live queue / progress -->
      <div id="queue" class="queue"></div>
      <div id="note" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- Library -->
    <div class="card">
      <div class="row-head">
        <h2 style="margin:0">Current videos</h2>
        <button id="refreshBtn" title="Refresh list">Refresh</button>
      </div>
      <div id="gallery" class="grid"><p class="muted">Loading…</p></div>
    </div>
  </div>

  <script>
    /* ==== CONFIG ==== */
    const CLOUD_NAME    = 'dcwn89zng';
    const UPLOAD_PRESET = 'rm_unsigned_video';
    const FOLDER        = 'readymag_videos';
    const TAG           = 'portfolio-vids';
    const MAX_SIZE      = 6 * 1024 * 1024; // 6 MB

    /* ==== Helpers ==== */
    const $ = sel => document.querySelector(sel);
    const vUrl   = id => `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/${id}.mp4`;
    const vJpg   = id => `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/${id}.jpg`;
    const gifUrl = id => `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${id}.gif`;

    const TOKEN_KEY = 'rm_delete_tokens';
    const tokens = JSON.parse(localStorage.getItem(TOKEN_KEY) || '{}');
    function saveToken(public_id, token){
      tokens[public_id] = token;
      localStorage.setItem(TOKEN_KEY, JSON.stringify(tokens));
    }
    const humanMB = bytes =>
      (isFinite(bytes) && bytes > 0) ? (bytes/1024/1024).toFixed(2) + ' MB' : '';

    function alertJSON(prefix, obj){
      try { alert(prefix + ' ' + JSON.stringify(obj, null, 2)); }
      catch { alert(prefix); }
    }

    /* ==== Delete helpers ==== */
    async function deleteByToken(public_id, token) {
      const fd = new FormData();
      fd.append('token', token);
      const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/delete_by_token`, { method:'POST', body: fd });
      const json = await resp.json().catch(()=> ({}));
      if (resp.ok && json?.result === 'ok') {
        delete tokens[public_id];
        localStorage.setItem(TOKEN_KEY, JSON.stringify(tokens));
        return { ok: true, json };
      }
      return { ok: false, json };
    }
    async function deleteByAdmin(public_id) {
      const resp = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ public_id })
      });
      const json = await resp.json().catch(()=> ({}));
      return { ok: resp.ok, json };
    }

    /* ==== Upload queue UI ==== */
    const q = $('#queue');
    const note = $('#note');

    function addQueueRow(filename){
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `
        <span class="name" title="${filename}">${filename}</span>
        <span class="pill">Uploading…</span>
        <div class="bar"><i></i></div>
      `;
      q.prepend(row);
      return row;
    }
    function addCopyBtn(parent, url){
      const copy = document.createElement('button');
      copy.textContent = 'Copy URL';
      copy.onclick = async () => {
        try {
          await navigator.clipboard.writeText(url);
          const old = copy.textContent; copy.textContent='Copied!'; setTimeout(()=>copy.textContent=old,1200);
        } catch(e) {}
      };
      parent.appendChild(copy);
    }
    function markSuccess(row, url, onDeleteClick){
      row.querySelector('.pill').textContent='Uploaded';
      row.querySelector('.pill').className='pill ok';
      const bar = row.querySelector('.bar'); if (bar) bar.remove();
      addCopyBtn(row, url);
      if (onDeleteClick) {
        const del = document.createElement('button');
        del.className = 'btn-danger';
        del.textContent = 'Delete';
        del.style.marginLeft = '8px';
        del.onclick = onDeleteClick;
        row.appendChild(del);
      }
    }
    function markError(row, msg){
      row.querySelector('.pill').textContent='Error';
      row.querySelector('.pill').className='pill err';
      const bar = row.querySelector('.bar'); if (bar) bar.remove();
      const err = document.createElement('span'); err.className='muted'; err.style.marginLeft='8px'; err.textContent = msg || 'Upload failed';
      row.appendChild(err);
    }

    /* ==== Cloudinary Upload Widget ==== */
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUD_NAME,
      uploadPreset: UPLOAD_PRESET,
      sources: ['local','url','google_drive','dropbox'],
      multiple: true,
      maxFileSize: MAX_SIZE,
      resourceType: 'auto',
      clientAllowedFormats: ['mp4','mov','webm','gif'],
      folder: FOLDER,
      tags: [TAG]
    }, (error, result) => {
      if (error) { note.textContent = 'Error: ' + (error.message || error); return; }
      if (!result) return;

      if (result.event === 'queues-start') note.textContent = 'Uploading…';
      if (result.event === 'queues-end')   note.textContent = 'All uploads finished.';

      if (result.event === 'upload-added') {
        const f = result.info?.files?.[0]?.file || result.info;
        const name = (f?.name || f?.original_filename || 'file').toString();
        result.info.__row = addQueueRow(name);
      }

      if (result.event === 'success') {
        const info = result.info;
        const row = info.__row || q.firstElementChild;

        const onDeleteClick = info.delete_token ? async () => {
          if (!confirm('Delete this file from Cloudinary?')) return;
          const r = await deleteByToken(info.public_id, info.delete_token);
          if (r.ok) { row.remove(); renderGallery(); }
          else { alertJSON('Delete failed (token):', r.json); }
        } : null;

        markSuccess(row, info.secure_url, onDeleteClick);

        if (info.delete_token && info.public_id) {
          saveToken(info.public_id, info.delete_token);
        }
        setTimeout(renderGallery, 800);
      }
    });

    $('#uploadBtn').addEventListener('click', () => widget.open());

    /* ==== Library (Current media) ==== */
    async function fetchListBoth() {
      const urls = [
        `https://res.cloudinary.com/${CLOUD_NAME}/video/list/${TAG}.json`,
        `https://res.cloudinary.com/${CLOUD_NAME}/image/list/${TAG}.json`,
      ];
      const results = await Promise.allSettled(urls.map(u => fetch(u + `?t=${Date.now()}`, { cache:'no-store' })));
      const jsons = await Promise.all(results.map(async r => (r.status==='fulfilled' && r.value.ok) ? r.value.json() : {resources:[]}));
      const merged = [...(jsons[0].resources||[]), ...(jsons[1].resources||[])]
        .sort((a,b)=>(b.version||0)-(a.version||0));
      return merged;
    }

    function makeCard(it){
      const isGif = (it.format||'').toLowerCase()==='gif';
      const box = document.createElement('div'); box.className='card-v';

      if (isGif) {
        box.innerHTML = `<img src="${gifUrl(it.public_id)}" alt="gif"/>`;
      } else {
        box.innerHTML = `
          <video controls playsinline preload="metadata" poster="${vJpg(it.public_id)}">
            <source src="${vUrl(it.public_id)}" type="video/mp4">
          </video>`;
      }

      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<span class="left">${it.public_id.split('/').pop()}.${it.format} ${humanMB(it.bytes) ? '— '+humanMB(it.bytes) : ''}</span>`;

      const btns = document.createElement('div'); btns.className='btns';
      const copy = document.createElement('button');
      copy.textContent = 'Copy URL';
      copy.onclick = () => navigator.clipboard.writeText(isGif ? gifUrl(it.public_id) : vUrl(it.public_id));
      btns.appendChild(copy);

      const wantDelete = async () => {
        if (!confirm('Delete this file from Cloudinary?')) return;
        let r = { ok:false, json:null };

        if (tokens[it.public_id]) {
          r = await deleteByToken(it.public_id, tokens[it.public_id]);
        }
        if (!r.ok) {
          r = await deleteByAdmin(it.public_id);
        }

        if (r.ok) {
          box.remove();
        } else {
          alertJSON('Delete failed (admin):', r.json);
        }
      };

      const del = document.createElement('button');
      del.className = 'btn-danger';
      del.textContent = 'Delete';
      del.onclick = wantDelete;
      btns.appendChild(del);

      meta.appendChild(btns);
      box.appendChild(meta);
      return box;
    }

    async function renderGallery(){
      const root = $('#gallery');
      try{
        const items = await fetchListBoth();
        if (!items.length){ root.innerHTML = '<p class="muted">No media yet.</p>'; return; }
        root.innerHTML = '';
        items.forEach(it => root.appendChild(makeCard(it)));
      }catch(e){
        root.innerHTML = '<p class="muted">Unable to load media.</p>';
        console.error(e);
      }
    }

    $('#refreshBtn').addEventListener('click', renderGallery);
    renderGallery();
    setInterval(renderGallery, 60000);
  </script>
</body>
</html>
